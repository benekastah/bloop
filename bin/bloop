#!/usr/bin/env node

var fs = require('fs');
var util = require('util');

var argv = require('minimist')(process.argv.slice(2));

var escodegen = require('escodegen');
var esmangle = require('esmangle');

var lex = require('../lexer');
var ast = require('../ast');
var helpers = require('../helpers');
var Compiler = require('../compiler').Compiler;

var infile = argv.c;
var outfile = argv.o;

var showTypeInfo = argv.T || argv['show-type-info'];

fs.readFile(infile, 'utf8', function (err, data) {
    if (err) {
        throw err;
    }

    var parser = require('../parser').parser;
    parser.lexer = lex.makeLexer();
    parser.yy = ast;

    var mod = parser.parse(data);
    // console.log(util.inspect(mod, {depth: 100, colors: true}));

    var compiler = new Compiler(mod);

    if (showTypeInfo) {
        var context = compiler.typeSystem.context.last();
        for (var prop in context) {
            console.log(prop + ': ' + context[prop]);
        }
        process.exit();
    }

    var jsAst = compiler.compile();
    var js = escodegen.generate(jsAst);
    if (outfile) {
        fs.writeFile(outfile, js, function (err) {
            if (err) { throw err; }
        });
    } else {
        console.log(js);
    }
});

// vim: ts=4 sts=4 sw=4 et
