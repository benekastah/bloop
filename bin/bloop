#!/usr/bin/env node

var fs = require('fs');
var util = require('util');

var argv = require('minimist')(process.argv.slice(2));

var bloop = require('../index');
var helpers = require('../helpers');

var infile = argv.c;
var outfile = argv.o;
var mangle = argv.m;
var optimize = argv.O;

var showTypeInfo = argv.T || argv['show-type-info'];
var showJsAst = argv.J || argv['show-js-ast'];

fs.readFile(infile, 'utf8', function (err, data) {
    if (err) {
        throw err;
    }

    var compiler = bloop.getCompiler(data);
    if (showTypeInfo) {
        compiler.analyseTypes();
        var context = compiler.typeSystem.context.last();
        for (var prop in context) {
            console.log(prop + ': ' + context[prop]);
        }
        process.exit();
    }

    var result = bloop.compile(compiler, {
        optimize: optimize,
        mangle: mangle,
        getAst: showJsAst
    });

    if (showJsAst) {
        helpers.log(result);
        process.exit();
    }

    if (outfile) {
        fs.writeFile(outfile, result, function (err) {
            if (err) { throw err; }
        });
    } else {
        console.log(result);
    }
});

// vim: ts=4 sts=4 sw=4 et
